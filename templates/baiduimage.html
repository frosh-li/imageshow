<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>碟花网</title>
  <script src='/js/jquery.js' type='text/javascript' charset='utf-8'></script>
  <script type="text/javascript" src="/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
  <script type="text/javascript" src="/fancybox/jquery.easing-1.4.pack.js"></script>
  <script type="text/javascript" src="/fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/fancybox/jquery.fancybox-1.3.4.css" type="text/css" media="screen" />
    <link rel=”icon” href=”/favicon.ico” mce_href=”/favicon.ico” type=”image/x-icon”>
    <link rel=”shortcut icon” href=”/favicon.ico” mce_href=”/favicon.ico” type=”image/x-icon”>
</head>
<body>
[[[commonheader:get_header()]]]
<div id="main" class="clearfix">
</div>
<a id="elevator" href="#" onclick="return false;" class="Indicator off btn wbtn">
            <strong>
                回到顶部
            </strong>
            <span>
            </span>
        </a>
<div style="clear:both;" id="loadingpanel"><div id="loadingmore">点击加载</div></div>
<script type="text/javascript">

var loadedPics = [],t = null;
var viewExistPics = [];
var colwidth = 237; //固定列的宽度
var initWidth = document.body.clientWidth;
var colnum = Math.floor(document.body.clientWidth / colwidth);
colnum = colnum < 4 ? 4:colnum;
var originColnum = colnum;
//document.body.clientWidth
window.onload = function(){
 for(var i = 0 ; i < colnum ; i++){
        $("<div class='col'></div>").appendTo($("#main"));
    }
    $("#main").css("width",colnum*colwidth+2 +"px");
    var elem = $('<div class="ele show"><ul class="clearfix">[[[space:get_cat_list('sss.html')]]]</ul></div>');
	elem.appendTo($(".col")[0]);
    setTimeout(function(){getData(currentOffset);},50);
};
window.onresize = function(){
    //return;
    var currentWidth = document.body.clientWidth;
    if(currentWidth == initWidth){
        return;
    }
    setTimeout(function(){
        delayWidth = document.body.clientWidth;
        if(delayWidth != currentWidth){
            return;
        }
        clearInterval(t);
        
        colnum = Math.floor(document.body.clientWidth / colwidth);
        colnum = colnum < 4 ? 4:colnum;
        if(originColnum == colnum)
            return;
        $("#main").html("");
        for(var i = 0 ; i < colnum ; i++){
            $("<div class='col'></div>").appendTo($("#main"));
        }
        $("#main").css("width",colnum*colwidth+2 +"px");
        var elem = $('<div class="ele show"><ul class="clearfix">[[[space:get_cat_list('sss.html')]]]</ul></div>');
	    elem.appendTo($(".col")[0]);
        var tmp = viewExistPics.slice(0);
        attachPicToMain(tmp);
        initWidth = delayWidth;
        originColnum = colnum;
    },500);
}
function attachPicToMain(obj){
	var arrelem = $("#main .col");
	var container = $(arrelem[0]);
	for(var i = 0 ; i<obj.length ;i++){
			//console.log(arrelem);
			$.each(arrelem,function(index,celem){
			//console.log(celem);
			if($(celem).innerHeight() < container.innerHeight()){
				container = $(celem);
			}
			});
			var m = obj[i];
			var elem = $("<div class='ele vis'><a href='"+m.source_l+"' class='grouped_elements'><img src='"+m.source+"' height='"+m.height+"' /\></a><div class='title'>"+m.title+"</div></div>");
			elem.appendTo(container);
			
	}
	var visEle = $(".vis");
	$("a.grouped_elements",visEle).fancybox();
	obj.length = 0;
	    $('.vis').animate({
			opacity: 1
		  }, 1000, function() {
		    $(this).removeClass("vis");
		  });
	
}
var inloading = false,
	nomore = false,
	startkey="";
function getData(start){
    if(!inloading && !nomore){
             inloading = true;
	    $.ajax({
		url:"/index?start="+start+(start == 0?"":"&startkey="+startkey),
		dataType:"json",
		type:"GET",
		success:function(data){
		    jsonFlickrApi(data);
		      currentOffset+=30;
		      inloading = false;
		}
	    });
    }
}
var pictures = [];
function jsonFlickrApi(obj){
    var photos = obj.results;
    	 
    if(photos.length == 0){jsonFlickrApi
    	$("#loadingmore").html("<img src='/images/end.png' /\>");
    	$("#loadingpanel").show();
    	nomore = true;
    	return;
    }
    for(var i = 0 ; i<photos.length ; i++){
            pictures.push({"width_l":500,"width":200,"source":"/dhnetimage/"+photos[i]['key']+"_s"+photos[i]['value']['ext'],"title":photos[i]['value']['title'],"source_l":"/dhnetimage/"+photos[i]['key']+photos[i]['value']['ext'],height:photos[i]['value']['height']});
    }
    startkey = photos[photos.length-1]['key'];
    viewExistPics = pictures.slice(0);
    attachPicToMain(pictures);
}
var currentOffset = 0 ;



window.onscroll = function(){
	if(document.body.offsetHeight - document.documentElement.clientHeight -document.body.scrollTop < 300 && inloading == false){
		getData(currentOffset);
	}
	if($(document.documentElement).scrollTop() > 0 || $(document.body).scrollTop() > 0){	
		$("#elevator").removeClass("off");
		$("#elevator").addClass("on");
		$("#elevator").die().live("click",function(){$("body,html").animate({scrollTop:0},500)});
	}else{
		$("#elevator").removeClass("on");
		$("#elevator").addClass("off");
	}
}
var loadingInter = setInterval(function(){
	if(nomore){
		clearInterval(loadingInter);
	}
	var D = document;
	if(D.body.offsetHeight > D.documentElement.clientHeight){
		$("#loadingmore").show();
	}
},50);
$("#loadingmore").click(function(){
    getData(currentOffset);
});
</script>
</body>
</html>
    
  
